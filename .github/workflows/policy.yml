# =============================================================================
# Policy Check Workflow
# =============================================================================
# Runs automated policy checks for forbidden launcher sources and unsafe patterns.
# This workflow ensures:
# - No forbidden launcher names (TLauncher, SKLauncher) are referenced
# - Image references use digest pins, not floating tags
# - Binary downloads are verified with checksums
# - No hardcoded credentials/secrets
#
# See: docs/PINNING_POLICY.md for full policy details
# =============================================================================

name: Policy Check

on:
    push:
        branches:
            - main
            - develop
            - "release/**"
    pull_request:
        branches:
            - main
            - develop
    workflow_dispatch: # Allow manual triggering

jobs:
    policy-check:
        name: Policy Compliance
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 1

            - name: Make policy check script executable
              run: chmod +x tests/policy-check.sh

            - name: Run policy checks
              run: ./tests/policy-check.sh --strict

            - name: Upload policy check results (on failure)
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: policy-check-results
                  path: |
                      .sisyphus/evidence/
                  retention-days: 7
                  if-no-files-found: ignore

    # Optional: Add to main CI workflow as a dependency
    # This job can be referenced by other workflows using:
    # needs: policy-check
    policy-status:
        name: Policy Status
        runs-on: ubuntu-latest
        needs: policy-check
        if: always()

        steps:
            - name: Check policy status
              run: |
                  if [[ "${{ needs.policy-check.result }}" == "success" ]]; then
                    echo "✅ All policy checks passed"
                    exit 0
                  else
                    echo "❌ Policy checks failed"
                    exit 1
                  fi
