name: Policy Check

on:
    push:
        branches:
            - main
            - develop
            - "release/**"
    pull_request:
        branches:
            - main
            - develop
    workflow_dispatch:

jobs:
    policy-check:
        name: Policy Compliance
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 1

            - name: Make policy check script executable
              run: chmod +x tests/policy-check.sh

            - name: Run policy checks
              run: ./tests/policy-check.sh --strict

            - name: Upload policy check results (on failure)
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: policy-check-results
                  path: |
                      test-results/evidence/
                  retention-days: 7
                  if-no-files-found: ignore

    policy-status:
        name: Policy Status
        runs-on: ubuntu-latest
        needs: policy-check
        if: always()

        steps:
            - name: Check policy status
              run: |
                  if [[ "${{ needs.policy-check.result }}" == "success" ]]; then
                    echo "✅ All policy checks passed"
                    exit 0
                  else
                    echo "❌ Policy checks failed"
                    exit 1
                  fi
