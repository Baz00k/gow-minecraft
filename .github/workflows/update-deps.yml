name: Update Dependencies

on:
    schedule:
        - cron: "0 6 * * 1"
    workflow_dispatch:

permissions:
    contents: write
    pull-requests: write

env:
    PINS_FILE: build/pins.env
    BASE_IMAGE: ghcr.io/games-on-whales/base-app
    BASE_IMAGE_TAG: edge
    PRISM_REPO: Diegiwg/PrismLauncher-Cracked

jobs:
    check-updates:
        runs-on: ubuntu-latest
        outputs:
            base-update: ${{ steps.base.outputs.update-available }}
            prism-update: ${{ steps.prism.outputs.update-available }}
            current-base: ${{ steps.base.outputs.current-digest }}
            new-base: ${{ steps.base.outputs.new-digest }}
            current-prism: ${{ steps.prism.outputs.current-version }}
            new-prism: ${{ steps.prism.outputs.new-version }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Check base image
              id: base
              run: .github/scripts/check-base-image.sh

            - name: Check Prism Launcher
              id: prism
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: .github/scripts/check-prism.sh

    update:
        needs: check-updates
        if: needs.check-updates.outputs.base-update == 'true' || needs.check-updates.outputs.prism-update == 'true'
        runs-on: ubuntu-latest
        env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Update base image
              if: needs.check-updates.outputs.base-update == 'true'
              run: .github/scripts/update-base-image.sh "${{ needs.check-updates.outputs.new-base }}"

            - name: Update Prism Launcher
              id: prism
              if: needs.check-updates.outputs.prism-update == 'true'
              run: .github/scripts/update-prism.sh "${{ needs.check-updates.outputs.new-prism }}"

            - name: Generate PR body
              id: body
              run: |
                  cat > /tmp/pr-body.md << 'EOF'
                  ## Dependency Updates
                  EOF

                  if [ "${{ needs.check-updates.outputs.base-update }}" = "true" ]; then
                      cat >> /tmp/pr-body.md << EOF

                  ### Base Image

                  | Field | Value |
                  |-------|-------|
                  | Previous | \`${{ needs.check-updates.outputs.current-base }}\` |
                  | New | \`${{ needs.check-updates.outputs.new-base }}\` |
                  EOF
                  fi

                  if [ "${{ needs.check-updates.outputs.prism-update }}" = "true" ]; then
                      cat >> /tmp/pr-body.md << EOF

                  ### Prism Launcher

                  Updated from v${{ needs.check-updates.outputs.current-prism }} to v${{ needs.check-updates.outputs.new-prism }}.

                  | Architecture | SHA256 |
                  |--------------|--------|
                  | x86_64 | \`${{ steps.prism.outputs.prism_x86_64_sha }}\` |
                  | aarch64 | \`${{ steps.prism.outputs.prism_aarch64_sha }}\` |

                  [Release notes](https://github.com/Diegiwg/PrismLauncher-Cracked/releases/tag/${{ needs.check-updates.outputs.new-prism }})
                  EOF
                  fi

                  cat >> /tmp/pr-body.md << 'EOF'

                  ---

                  *Auto-generated by update-deps workflow*
                  EOF

                  echo "file=/tmp/pr-body.md" >> "$GITHUB_OUTPUT"

            - name: Create PR
              uses: peter-evans/create-pull-request@v7
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  commit-message: |
                      chore: update dependencies

                      - Base image: ${{ needs.check-updates.outputs.base-update == 'true' && needs.check-updates.outputs.new-base || 'no change' }}
                      - Prism Launcher: ${{ needs.check-updates.outputs.prism-update == 'true' && needs.check-updates.outputs.new-prism || 'no change' }}
                  title: "chore: update dependencies"
                  body-path: /tmp/pr-body.md
                  branch: auto-update/deps-${{ github.run_number }}
                  labels: automated, dependencies
                  delete-branch: true

    no-updates:
        needs: check-updates
        if: needs.check-updates.outputs.base-update != 'true' && needs.check-updates.outputs.prism-update != 'true'
        runs-on: ubuntu-latest
        steps:
            - run: echo "All dependencies up to date"
